# Astronomer feature deployment GitHub action that create the Astronomer Deployment
# based on the Astronomer deployment template file .github/astro_feature_deployment_template.yaml

name: Create astro feature deployment
run-name: Create astro feature deployment
on:
  workflow_dispatch:

jobs:
  check_conditions:
    name: Check conditions
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      should-run-next: ${{ steps.condition-check.outputs.run-next }}
    steps:
      - id: condition-check
        name: Conditions are met
        run: |
          current_repo_name=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          repo_name='ci-cd'
          echo "The repo name is $repo_name"
          echo "The repo name is $current_repo_name"
          echo "The branch name is ${{ github.ref }} "
          if [[ "$current_repo_name" == "$repo_name" ]] && [[ "${{ github.ref }}" != 'refs/heads/main' ]] && [[ "${{ github.ref }}" != 'refs/heads/dev' ]]; then
            echo "run-next=true" >> "$GITHUB_OUTPUT"
            echo "Conditions are met."
          else
            echo "run-next=false" >> "$GITHUB_OUTPUT"
            echo "Deployment can only be created from non-dev and non-main branches by $repo_name."
          fi
          

  create_deployment:
    name: Create astro deployment for the PR
    needs: check_conditions
    if: needs.check_conditions.outputs.should-run-next == 'true'
    runs-on: ubuntu-latest
    environment: dev    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
